{% extends "tours/base.html" %}
{% load staticfiles %}
{% block content %}
<div id="map"></div>
<img src="{% static 'img/spinner.gif' %}" id="loading">
{% endblock %}

{% block javascript %}
<script>

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(myMap, showError);
    } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
}

function myMap(position) {
  var myLatLng = {lat: position.coords.latitude, lng: position.coords.longitude};

  var map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: position.coords.latitude, lng: position.coords.longitude},
            zoom: 17,
            mapTypeControlOptions: {
              mapTypeIds: ['satellite']
            }
          });

  var dog = {
      url: "{% static 'img/dog.png' %}", // url
      scaledSize: new google.maps.Size(50, 50), // scaled size
      origin: new google.maps.Point(0,0), // origin
      anchor: new google.maps.Point(25, 25) // anchor
  };

  var green = {
      url: "{% static 'img/green_icon.png' %}", // url
      scaledSize: new google.maps.Size(30, 50), // scaled size
      origin: new google.maps.Point(0,0), // origin
      anchor: new google.maps.Point(25, 25) // anchor
  };

  {% for location in locations %}
    var location_marker = new google.maps.Marker({
        position: new google.maps.LatLng(parseFloat({{location.latitude}}),parseFloat({{location.longitude}})),
        map: map,
        title: '{{location.name}}',
        icon: green
    });
  {% endfor %}

  var marker = new google.maps.Marker({
            position: myLatLng,
            map: map,
            title: 'Current Location',
            icon: dog
          });

  moveMarker(map, marker)
}

function moveMarker( map, marker ) {
    function updatePosition(position){
        marker.setPosition( new google.maps.LatLng( position.coords.latitude, position.coords.longitude ) );
        // map.panTo( new google.maps.LatLng( 0, 0 ) );
    }
    //delayed so you can see it move
    setInterval( function(){ 
        if (navigator.geolocation) {
            console.log("Updating position");
            navigator.geolocation.getCurrentPosition(updatePosition, showError);
        } else {
            x.innerHTML = "Geolocation is not supported by this browser.";
        }
        
    }, 3500 );

};

</script>
<!-- Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcW3Bs3eY07QCJj3_yR7p0ISiyPxg3mz0&callback=getLocation"
  type="text/javascript"></script>
{% endblock %}